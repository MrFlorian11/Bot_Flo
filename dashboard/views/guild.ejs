<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Configuration ‚Äî Guilde <%= guildId %></title>
  <link rel="stylesheet" href="/public/style.css"/>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="brand">
      <div class="logo"><span>üõ†Ô∏è</span></div>
      <div>Winnie Dashboard</div>
    </div>
    <div class="nav">
      <a href="/dashboard">Mes serveurs</a>
      <span class="sep">‚Ä¢</span>
      <a href="/logout">Se d√©connecter</a>
      <div class="userpill">
        <% if (user.avatar) { %>
          <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png?size=64" alt="">
        <% } %>
        <span class="name"><%= user.username %></span>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <h1>Configuration ‚Äì Guilde <code><%= guildId %></code></h1>

  <% if (saved) { %>
    <div class="alert success">‚úÖ Sauvegard√©.</div>
  <% } %>

  <form method="post" action="/guild/<%= guildId %>">
    <div class="grid-2">
      <!-- Colonne gauche : salon -->
      <section class="card">
        <h2>Salon de logs</h2>

        <label for="channelId">Salon de logs</label>
        <select class="input" id="channelId" name="channelId">
          <option value="">Chargement des salons...</option>
        </select>
        <div class="help">Choisis le salon o√π le bot enverra les logs.</div>
      </section>

      <!-- Colonne droite : cat√©gories -->
      <section class="card">
        <h2>Cat√©gories</h2>
        <div style="display:grid; gap:10px;">
          <% cats.forEach(([key, label]) => { %>
            <label class="switch">
              <span class="label"><%= label %></span>
              <div>
                <input class="toggle-input" type="checkbox" name="cat_<%= key %>" <%= cfg.categories[key] !== false ? 'checked' : '' %> />
                <span class="toggle"></span>
              </div>
            </label>
          <% }) %>
        </div>
      </section>
    </div>

    <div style="display:flex; gap:10px; margin-top:12px">
      <button class="btn primary" type="submit">üíæ Enregistrer</button>
      <a class="btn ghost" href="/dashboard">‚Üê Retour</a>
    </div>
  </form>

  <section class="card" style="margin-top:16px">
    <h2>Tester</h2>
    <p>Dans Discord : <code>/logs test</code> pour envoyer un message de test dans le salon configur√©.</p>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const select = document.getElementById('channelId');
  const guildId = "<%= guildId %>";
  const current = "<%= cfg.channelId || '' %>";

  try {
    const res = await fetch(`/api/guild/${guildId}/channels`);
    const data = await res.json();
    if (!data.ok) throw new Error('√âchec API');

    select.innerHTML = '';
    data.channels.forEach(ch => {
      const opt = document.createElement('option');
      opt.value = ch.id;
      opt.textContent = `#${ch.name}`;
      if (current === ch.id) opt.selected = true;
      select.appendChild(opt);
    });

    if (data.channels.length === 0) {
      select.innerHTML = '<option value="">Aucun salon texte trouv√©</option>';
    }
  } catch (err) {
    console.error(err);
    select.innerHTML = '<option value="">‚ö†Ô∏è Impossible de charger les salons</option>';
  }
});
</script>

<footer>¬© <%= new Date().getFullYear() %> ‚Äî Winnie</footer>
</body>
</html>
